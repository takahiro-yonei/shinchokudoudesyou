Ext.define("Ext.force.Force",{statics:{forceInstance:null,},config:{clientId:null,loginUrl:"https://login.salesforce.com/",proxyUrl:null,saveTokenLocally:true,authzHeader:"Authorization",refreshToken:null,sessionId:null,apiVersion:null,instanceUrl:null,asyncAjax:true},constructor:function(a){this.initConfig(a);if(this.getProxyUrl()===null){if(location.protocol==="file:"){this.setProxyUrl(null)}else{this.setProxyUrl(location.protocol+"//"+location.hostname+"/services/proxy")}this.setAuthzHeader("Authorization")}else{this.setAuthzHeader("X-Authorization")}},authenticate:function(f){var h=f,c=f;if(this.getSessionId()==null){var a={};if(window.location.hash&&window.location.href.indexOf("access_token")>0){var d=window.location.hash.substr(1);var g=d.split("&");for(var b in g){var e=g[b].split("=");a[e[0]]=unescape(e[1])}}else{if(Ext.isObject(c)&&(c.accessToken||(c.data&&c.data.accessToken))){if(c.data){c=c.data}a={access_token:c.accessToken,instance_url:c.instanceUrl,refresh_token:c.refreshToken}}else{if(this.getSaveTokenLocally()&&typeof(localStorage)!="undefined"&&localStorage.salesforceToken){a=JSON.parse(localStorage.salesforceToken)}}}if(a.access_token){this.sessionCallback(a)}else{if(Ext.isString(h)){url=this.getAuthorizeUrl(h);window.location.href=url}else{}}}else{if(window.location.href.indexOf("visual.force.com")>-1){a={access_token:this.getSessionId(),instance_url:"https://"+window.location.hostname,refresh_token:null};this.sessionCallback(a)}}},getAuthorizeUrl:function(a){return this.getLoginUrl()+"services/oauth2/authorize?display=touch&response_type=token&client_id="+escape(this.getClientId())+"&redirect_uri="+escape(a)},sessionCallback:function(a){if(typeof a==="undefined"||typeof a.access_token==="undefined"){}else{this.setSessionToken(a.access_token,null,a.instance_url,a.refresh_token);window.location.href=window.location.href.split("#")[0]+"#";Ext.force.Force.forceInstance=this;if(typeof(localStorage)!="undefined"){if(this.getSaveTokenLocally()){console.log("Storing oauth");localStorage.salesforceToken=JSON.stringify(a)}else{localStorage.salesforceToken=null;delete localStorage.salesforceToken}}}},refreshAccessToken:function(e,b){var c=this;var a=this.getLoginUrl()+"/services/oauth2/token";console.log("Refreshing access token");var d={};if(c.getProxyUrl()!==null){d["SalesforceProxy-Endpoint"]=a}return Ext.Ajax.request({method:"POST",url:(c.getProxyUrl()!==null)?c.getProxyUrl():a,disableCaching:true,params:"grant_type=refresh_token&client_id="+this.getClientId()+"&refresh_token="+this.getRefreshToken(),success:e,failure:b,dataType:"json",headers:d})},setSessionToken:function(g,e,d,c){this.setSessionId(g);this.setApiVersion((typeof e==="undefined"||e===null)?"v28.0":e);if(typeof d==="undefined"||d==null){var f=location.hostname.split(".");var a=null;if(f.length==4&&f[1]==="my"){a=f[0]+"."+f[1]}else{if(f.length==3){a=f[0]}else{a=f[1]}}this.setInstanceUrl("https://"+a+".salesforce.com")}else{this.setInstanceUrl(d)}if(c!=undefined){this.setRefreshToken(c)}if(this.getSaveTokenLocally()&&typeof(localStorage)!="undefined"&&localStorage.salesforceToken){var b=JSON.parse(localStorage.salesforceToken);b.access_token=this.getSessionId();b.instance_url=this.getInstanceUrl();localStorage.salesforceToken=JSON.stringify(b)}},ajax:function(i,h,f,a,g,b){var e=this;var c=this.getInstanceUrl()+"/services/data"+i;var d={"Content-Type":"application/json","X-User-Agent":"sencha-salesforce-toolkit/"+e.getApiVersion()};d[e.getAuthzHeader()]="OAuth "+e.getSessionId();if(e.getProxyUrl()!==null){d["SalesforceProxy-Endpoint"]=c}return Ext.Ajax.request({method:a||"GET",async:e.getAsyncAjax(),url:(this.getProxyUrl()!==null)?this.getProxyUrl():c,headers:d,disableCaching:true,jsonData:g,success:h,failure:(!e.getRefreshToken()||b)?f:function(k,j){if(k.status===401){e.refreshAccessToken(function(l){var m=Ext.JSON.decode(l.responseText);e.setSessionToken(m.access_token,null,m.instance_url);e.ajax(i,h,f,a,g,true)},f)}else{f(k,j)}}})},getChatterFile:function(f,g,h,c,a){var e=this;var b=this.getInstanceUrl()+f;var d=new XMLHttpRequest();d.open("GET",(this.getProxyUrl()!==null)?this.getProxyUrl():b,true);d.responseType="arraybuffer";d.setRequestHeader(e.getAuthzHeader(),"OAuth "+e.getSessionId());d.setRequestHeader("X-User-Agent","sencha-salesforce-toolkit/"+e.getApiVersion());if(this.getProxyUrl()!==null){d.setRequestHeader("SalesforceProxy-Endpoint",b)}d.onreadystatechange=function(){if(d.readyState==4){if(d.status==200){try{h(d.response)}catch(i){alert("Error reading the response: "+i.toString())}}else{if(d.status==401&&!a){e.refreshAccessToken(function(j){var k=Ext.JSON.decode(j.responseText);e.setSessionToken(k.access_token,null,k.instance_url);e.getChatterFile(f,g,h,c,true)},c)}else{c(d,d.statusText,d.response)}}}};d.send()},apexrest:function(k,j,g,a,i,h,b){var f=this,e,c=this.getInstanceUrl()+"/services/apexrest"+k,d={"Content-Type":"application/json","X-User-Agent":"sencha-salesforce-toolkit/"+f.getApiVersion()};d[f.getAuthzHeader()]="OAuth "+f.getSessionId();if(f.getProxyUrl()!==null){d["SalesforceProxy-Endpoint"]=c}if(h===null){h={}}for(e in h){d[e]=h[e]}return Ext.Ajax.request({method:a||"GET",async:f.getAsyncAjax(),url:(f.getProxyUrl()!==null)?f.getProxyUrl():c,headers:d,disableCaching:true,jsonData:i,success:j,failure:(!f.getRefreshToken()||b)?g:function(m,l){if(m.status===401){f.refreshAccessToken(function(n){var o=Ext.JSON.decode(n.responseText);f.setSessionToken(refresh.access_token,null,refresh.instance_url);f.apexrest(k,j,g,a,i,h,true)},g)}else{if(g){g(m,l)}}}})},versions:function(b,a){return this.ajax("/",b,a)},resources:function(b,a){return this.ajax("/"+this.getApiVersion()+"/",b,a)},describeGlobal:function(b,a){return this.ajax("/"+this.getApiVersion()+"/sobjects/",b,a)},metadata:function(a,c,b){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+a+"/",c,b)},describe:function(a,c,b){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+a+"/describe/",c,b)},create:function(b,a,d,c){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+b+"/",d,c,"POST",JSON.stringify(a))},retrieve:function(b,f,d,e,c){if(!arguments[4]){c=e;e=d;d=null}var a=d?"?fields="+d:"";this.ajax("/"+this.getApiVersion()+"/sobjects/"+b+"/"+f+a,e,c)},upsert:function(b,e,d,a,f,c){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+b+"/"+e+"/"+d+"?_HttpMethod=PATCH",f,c,"POST",JSON.stringify(a))},update:function(b,e,a,d,c){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+b+"/"+e+"?_HttpMethod=PATCH",d,c,"POST",JSON.stringify(a))},del:function(a,d,c,b){return this.ajax("/"+this.getApiVersion()+"/sobjects/"+a+"/"+d,c,b,"DELETE")},query:function(c,b,a){return this.ajax("/"+this.getApiVersion()+"/query?q="+escape(c),b,a)},queryMore:function(c,e,b){var d="services/data";var a=c.indexOf(d);if(a>-1){c=c.substr(a+d.length)}else{}return this.ajax(c,e,b)},search:function(b,c,a){return this.ajax("/"+this.getApiVersion()+"/search?q="+escape(b),c,a)}});Ext.define("Ext.force.ForceReader",{extend:Ext.data.reader.Json,alias:"reader.force",config:{rootProperty:"records"},getRoot:function(a){if(a.records){return a.records}if(a.id){return[{Id:a.id}]}if(a.request.options.operation.getAction()=="destroy"&&a.status>=200&&a.status<300){return[{Id:a.request.options.records[0].getId()}]}return a}});Ext.define("Ext.force.ForceWriter",{extend:Ext.data.writer.Json,alias:"writer.force",config:{writeAllFields:false},writeRecords:function(a,b){var c=b;if(Ext.isArray(b)&&b.length>1){Ext.Logger.error("ForceWriter: Cannot update more than one record at once. received "+b.length+" records.")}if(Ext.isArray(c)){c=b[0]}if(c){c=Ext.apply({},c);delete c[a.getOperation().getModel().getIdProperty()];a.setJsonData(c)}return a}});Ext.define("Ext.force.ForceProxy",{extend:Ext.data.proxy.Ajax,alias:"proxy.force",config:{batchActions:false,useDefaultXhrHeader:true,actionMethods:{create:"POST",read:"GET",update:"POST",destroy:"DELETE"},table:null,headers:{"Content-Type":"application/json"},reader:"force",writer:"force"},doRequest:function(a,h,b){var d=this,f=d.getWriter(),c=d.buildRequest(a),e=Ext.force.Force.forceInstance;c.setConfig({headers:d.getHeaders(),timeout:d.getTimeout(),method:d.getMethod(c),callback:d.createRequestCallback(c,a,h,b),scope:d,proxy:d,useDefaultXhrHeader:d.getUseDefaultXhrHeader()});var g=c.getHeaders();g["X-User-Agent"]="sencha-touch/"+e.getApiVersion();g[e.getAuthzHeader()]="OAuth "+e.getSessionId();if(e.getProxyUrl()!==null){g["SalesforceProxy-Endpoint"]=c.getUrl();c.setUrl(e.getProxyUrl())}if(a.getWithCredentials()||d.getWithCredentials()){c.setWithCredentials(true);c.setUsername(d.getUsername());c.setPassword(d.getPassword())}c=f.write(c);Ext.Ajax.request(c.getCurrentConfig());return c},buildRequest:function(a){var d=this,e=Ext.applyIf(a.getParams()||{},d.getExtraParams()||{}),c,b=d.getParams(a);c=Ext.create("Ext.data.Request",{params:e,args:b,action:a.getAction(),records:a.getRecords(),url:a.getUrl(),operation:a,proxy:d});c.setUrl(d.buildUrl(c));a.setRequest(c);return c},getMethod:function(a){return this.getActionMethods()[a.getAction()]},createRequestCallback:function(d,a,f,b){var c=this,e=Ext.force.Force.forceInstance;return function(h,i,g){if(!i&&e.getRefreshToken()&&g.status===401){e.refreshAccessToken(function(j){var k=Ext.JSON.decode(j.responseText);e.setSessionToken(k.access_token,null,k.instance_url);c.doRequest(a,f,b)},function(j){c.processResponse(i,a,d,j,f,b)})}else{c.processResponse(i,a,d,g,f,b)}}},getUrl:function(h){var l=this,a,c=Ext.force.Force.forceInstance,f=h.getAction(),i=this.getModel(),k=l.getTable()?l.getTable():i.getName(),g=h.getOperation(),e=h.getArgs(),d=l.getSortParam(),o=l.getPageParam(),m=l.getLimitParam(),j=l.getStartParam(),b=l.getFilterParam();a=c.getInstanceUrl()+"/services/data/"+c.getApiVersion()+"/";var n={read:function(){var q=l.getModel().getFields().keys,p;p="select "+q.join(",")+" from "+k;if(e[b]){p+=" WHERE "+e[b]}if(e[d]){p+=" ORDER BY "+e[d]}if(e[o]!==undefined){p+=" LIMIT "+parseInt(e[m],10)+" OFFSET "+parseInt(e[j],10)}return"query?q="+encodeURIComponent(p)},create:function(){var q=g.getRecords()[0],p="sobjects/"+k+"/";return p},update:function(){var q=g.getRecords()[0],p="sobjects/"+k+"/"+q.get(i.getIdProperty())+"?_HttpMethod=PATCH";return p},destroy:function(){var q=g.getRecords()[0],p="sobjects/"+k+"/"+q.get(i.getIdProperty());return p}};a+=n[f]();return a},encodeSorters:function(f){var d=[],e=f.length,c=0,b="",a=[];for(c in f){a.push(f[c].getProperty()||f[c].getSortProperty())}a=Ext.clean(a);b=a.join(", ")+" "+f[0].getDirection();return b},encodeFilters:function(b){var c=[],d,h="",a,e=this.getModel(),f=e.getFields(),j,g;for(d in b){if(b[d].getProperty()&&b[d].getValue()!==undefined){c.push({property:b[d].getProperty(),value:b[d].getValue()})}}if(c.length==0){return nil}for(d in c){a=c[d];j=f.get(a.property);if(a.property=="SOQL"){c[d]=a.value}else{if(Ext.isBoolean(a.value)){c[d]=a.property+" = "+(c[d].value?"TRUE":"FALSE")}else{if(j&&j.getType().type=="date"){if(Ext.isDate(a.value)){c[d]=a.property+" = "+a.value.toISOString()}else{c[d]=a.property+" = "+a.value}}else{if(Ext.isString(a.value)){var k=a.value.indexOf("%")!=-1;c[d]=a.property+(k?" LIKE ":" = ")+"'"+a.value+"'"}else{Ext.Logger.warn("ForceProxy does not handle the filter data type for "+a.property+" of type "+typeof a.value);c[d]=a.property+" = "+a.value}}}}}h=c.join(" AND ");return h}});